# ibetインフラ構成
## 1. 【全体構成】  

- プロダクション、ステージング用２種類のAWSアカウントが存在する。  
- プロダクション用のAWSアカウント上には、プロダクション環境のみ存在する。  
- ステージング用のAWSアカウントには、ステージング環境、開発環境が存在する。  
- 本来は各社ごとにAWSアカウントを分ける方式(現在RelicはNVC用のAWSアカウント配下に存在)  
- セキュリティ確保のため、各社ごとにVPCを分離。  
- 今回は各環境毎に、NVC用VPCと、コミュニティ用VPCの２種類を用意している。
- 開発環境はアプリケーションの開発環境。1EC2上でDocker Composeを使って起動している。  
- ステージング環境はお客様受け入れ＋NVCの営業用の環境。お客様が自由に試用が可能。  
- プロダクション環境はステージングで受け入れが完了したアプリケーションを可動させる環境。

![](./docs/system_overview_v2.png)


### 1.1. node-api
![](./docs/apinode_overview_v2.png)


- iOSアプリ(Wallet)から接続を受け付けるためのクラスタ    
- WAF/Shield、外部ALB、Nginx Proxy、内部ALB、APコンテナ、RDS、SQS、SNS、S3、FireBaseを組み合わせて構成される    


#### 1.1.1 WAF/Shield
- 外部からの不正侵入を抑止するために設置    
- 日本国外からのIPアドレスからのアクセス抑止、単位時間あたりの同一IPからの連続アクセス抑止、SQLインジェクション抑止フィルタを実装    
- 外部ALBにアドインしている    


#### 1.1.2 外部ALB
- nginxを冗長構成するため、かつ、HTTPS→HTTPへ復号化を実施するためにPlublicネットワーク上に設置    
- ドメインはRoute53に格納したNVCのドメイン(api.ibet.jp)を利用  
- 証明書はACMにて作成したAmazon作成の証明書を適用    
- Port443でListenしたものを後ろのnginx Proxyの80番ポートにフォワーディング 
- 背後のnginx proxyが全滅して処理を返せない場合、503エラーとステータスコード999を返却(要確認) 
- アクセスログはS3上に格納している  


#### 1.1.3 nginx Proxy
- DMZに配置し、basic認証機能を搭載することでアクセス制御を実装    
- ECSクラスタ上で可動する  
- AWSのALBが定期的にIPアドレスが変わるため、定期的にキャッシュしたDNSを再読込する機能を実装している  
- ログはCloudwatch logsに出力。    


#### 1.1.4 内部ALB
- APコンテナ、Quorumコンテナを冗長化するために、Privateネットワーク上に設置    
- Port80でListenしたものを後ろのAPコンテナの5000番ポートにフォワーディング 
- Port80でListenしたものを後ろのQuorumコンテナの8443番ポートにフォワーディング 
- ログはCloudwatch logsに出力。    


### 1.2. satoshi
* ここに特徴など。
* メモメモ
### 1.3. issuer
* ここに特徴など。
* メモメモ
### 1.4. bank
* ここに特徴など。
* メモメモ

```
手順、コマンドを書く
```

